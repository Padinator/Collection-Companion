on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
name: Inspections    
jobs:

  java-tests:
    runs-on: ubuntu-latest
    name: Checkstyle job ðŸ¥Š
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Run check style
      uses: nikitasavinov/checkstyle-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        reporter: 'github-pr-check'
      
  compile:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ 21 ]
    name: Java ${{ matrix.java }} compile
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'adopt'
          java-package: jdk
          java-version: ${{ matrix.java }}
      - name: Compile the Project
        working-directory: github-actions-java-maven
        run: mvn -B compile

  build:
    runs-on: ubuntu-latest
    needs: compile
    name: Build the Maven Project
    steps:
    - uses: actions/checkout@v3
    - uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
          distribution: 'adopt'
          java-version: '21'
          java-package: jdk
    - name: Build and test project
      working-directory: github-actions-java-maven
      run: mvn -B verify
    - name: Upload Maven build artifact
      uses: actions/upload-artifact@v3
      with:
        name: artifact.jar
        path: github-actions-java-maven/target/github-actions-java-maven.jar

  deploy:
    runs-on: ubuntu-latest
    needs: build
    name: Build Docker Container and Deploy to Kubernetes
    steps:
    - uses: actions/checkout@v3
    - name: Download Maven build artifact
      uses: actions/download-artifact@v3
      with:
        name: artifact.jar
        path: github-actions-java-maven/target
    - name: Build Docker container
      working-directory: github-actions-java-maven
      run: |
        docker build -t de.rieckpil.blog/github-actions-sample .
    - name: Access secrets
      env:
        github_token: ${{ secrets.GITHUB_TOKEN }}
      run: echo "Content of secret - $SUPER_SECRET"
    - name: Push Docker images
      run: echo "Pushing Docker image to Container Registry (e.g. ECR)"
    - name: Deploy application
      run: echo "Deploying application (e.g. Kubernetes)"

  playwright:
    name: Playwright ðŸŽ­
    timeout-minutes: 20
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 18
    - name: Navigate to docker-compose file
      run: cd ..
    - name: Start containers
      run: |
        sudo chmod -R 777 .
        docker compose up --detach --wait --wait-timeout 2000
    - name: Install Playwright
      run: |
        npm install playwright@latest
        npx playwright install --with-deps
        npm install --save-dev @playwright/test
    - name: Run Playwright tests
      run: |
        cd tests/browser-test
        npx playwright test
    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: tests/browser-test/playwright-report/
        retention-days: 5
        
  notify-teams:
    runs-on: ubuntu-latest
    ##needs: [mega-linter, unit-tests, playwright]
    steps:
    - uses: actions/checkout@v3
    - name: Teams Notification ðŸ“£
      env:
        PR_NAME: ${{ github.event.pull_request.title }}
      if: success() && 1 == 2 #muss am ende entfernt werden
      run: |
        # Check if Workflow already successfully ran 
        REPO_OWNER=${{ github.event.repository.owner.login }}
        REPO_NAME=${{ github.event.repository.name }}
        
        BRANCH_JSON=$(curl -s https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/runs?branch=${{ github.event.pull_request.head.ref }} \
        -H "Authorization: Bearer ${{ secrets.GH_BOT_TOKEN }}")
        echo $BRANCH_JSON | grep -q '"conclusion": "success"' \
        && echo "Messaged already published" \
        && exit 0
        
        # Teams Notification functionality
        PR_URL="https://github.com/${{ github.repository }}/pull/${{ github.event.number }}"
        echo "name:"
        echo $PR_NAME
        ESCAPED_PR_NAME=$(echo "$PR_NAME" | sed 's/\\/\\\\/g; s/"/\\\"/g')
        #echo 
        json=$(echo '
        {
            "type": "message",
            "attachments": [
                {
                    "contentType": "application/vnd.microsoft.card.adaptive",
                    "content": {
                        "type": "AdaptiveCard",
                        "body": [
                            {
                                "type": "TextBlock",
                                "text": "Review benÃ¶tigt!",
                                "weight": "bolder",
                                "size": "medium"
                            },
                            {
                                "type": "TextBlock",
                                "text": "Pull Request: '$ESCAPED_PR_NAME'",
                                "wrap": true
                            },
                            {
                                "type": "TextBlock",
                                "text": "<at>Patrick</at>,  <at>Dominik</at>,  <at>Tom</at>, <at>Stefan</at>",
                                "wrap": true
                            }
                        ],
                        "actions": [
                            {
                                "type": "Action.OpenUrl",
                                "title": "GitHub Pull Request",
                                "url": "'$PR_URL'"
                            }
                        ],
                        "msteams": {
                            "entities": [
                                {
                                    "type": "mention",
                                    "text": "<at>Patrick</at>",
                                    "mentioned": {
                                        "id": "patrick.dieser@th-bingen.de",
                                        "name": "Patrick"
                                    }
                                },
                                {
                                    "type": "mention",
                                    "text": "<at>Dominik</at>",
                                    "mentioned": {
                                        "id": "dominik.sauter@th-bingen.de",
                                        "name": "Dominik"
                                    }
                                },
                                {
                                    "type": "mention",
                                    "text": "<at>Tom</at>",
                                    "mentioned": {
                                        "id": "tom.lauth@th-bingen.de",
                                        "name": "Tom"
                                    }
                                },
                                {
                                    "type": "mention",
                                    "text": "<at>Stefan</at>",
                                    "mentioned": {
                                        "id": "stefan.heyne@th-bingen.de",
                                        "name": "Stefan"
                                    }
                                }      
                            ]
                        }
                    }
                }
            ]
        }')
        echo "JSON: " $json
        response=$(curl --location ${{ secrets.TEAMS_GITHUB_HOOK }} \
        --header 'Content-Type: text/plain' \
        --data-raw "$json")
        echo "Response:"
        echo $response
        if [ "$response" != "1" ]
        then
          echo "Bad Request!"
          exit 1
        fi        
